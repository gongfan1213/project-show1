ä»¥ä¸‹æ˜¯å…³äºŽæ–‡ä»¶ä¸Šä¼ æ¨¡å—çš„æŠ€æœ¯å®žçŽ°ç»†èŠ‚åˆ†æžï¼š

### 1. OSSä½¿ç”¨æƒ…å†µ
**âœ… ç³»ç»Ÿç¡®å®žä½¿ç”¨äº†OSS**ï¼Œä¸»è¦ä½“çŽ°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1. **ä¸Šä¼ å‡­è¯èŽ·å–**ï¼š
```typescript
// ä»£ç ä¸­å‡ºçŽ°çš„ä¸Šä¼ å‡­è¯ç±»åž‹æžšä¸¾
enum GetUpTokenFileTypeEnum {
  Edit2dLocal = 'edit_2d_local', // ç´ æä¸Šä¼ 
  Edit2dProject = 'edit_2d_project' // é¡¹ç›®æ–‡ä»¶ä¸Šä¼ 
}
```

2. **ä¸Šä¼ æŽ¥å£è°ƒç”¨**ï¼š
```typescript
// æ ¸å¿ƒä¸Šä¼ æ–¹æ³•
upload2dEditFile(
  file: File, 
  fileType: GetUpTokenFileTypeEnum, // ä½¿ç”¨OSSå‡­è¯ç±»åž‹
  projectId?: string,
  canvasId?: string
)
```

### 2. æ–‡ä»¶ä¸Šä¼ ç›®çš„åœ°
**ðŸ—„ï¸ æ–‡ä»¶ä¸Šä¼ åˆ°é˜¿é‡Œäº‘OSS**ï¼Œå…·ä½“å­˜å‚¨è·¯å¾„ç»“æž„å¦‚ä¸‹ï¼š

| æ–‡ä»¶ç±»åž‹ | OSSè·¯å¾„ç¤ºä¾‹ | è¯´æ˜Ž |
|---------|------------|-----|
| è®¾è®¡ç´ æ | `edit_2d_local/{user_id}/{timestamp}_hash.webp` | ç”¨æˆ·ç§æœ‰ç´ æåº“ |
| é¡¹ç›®æ–‡ä»¶ | `edit_2d_project/{project_id}/canvas_{canvas_id}/layers/layer1.png` | é¡¹ç›®ä¸“å±žå­˜å‚¨ç©ºé—´ |
| ä¸´æ—¶æ–‡ä»¶ | `temp/{session_id}/upload_12345.svg` | ä¸´æ—¶å­˜å‚¨åŒºåŸŸ |

### 3. ä¸Šä¼ å®žçŽ°æœºåˆ¶
**ðŸš€ å®Œæ•´ä¸Šä¼ æµç¨‹**ï¼š

```mermaid
sequenceDiagram
    participant å‰ç«¯
    participant ä¸šåŠ¡æœåŠ¡å™¨
    participant OSS

    å‰ç«¯->>ä¸šåŠ¡æœåŠ¡å™¨: 1. è¯·æ±‚ä¸Šä¼ å‡­è¯(POST /get-oss-token)
    ä¸šåŠ¡æœåŠ¡å™¨->>OSS: 2. ç”Ÿæˆä¸´æ—¶STSå‡­è¯
    OSS-->>ä¸šåŠ¡æœåŠ¡å™¨: 3. è¿”å›žä¸´æ—¶AccessKey
    ä¸šåŠ¡æœåŠ¡å™¨-->>å‰ç«¯: 4. è¿”å›žä¸Šä¼ ç­–ç•¥(å«ç­¾å)
    å‰ç«¯->>OSS: 5. ç›´ä¼ æ–‡ä»¶(PUT /{bucket}/object)
    OSS-->>å‰ç«¯: 6. è¿”å›žä¸Šä¼ ç»“æžœ
    å‰ç«¯->>ä¸šåŠ¡æœåŠ¡å™¨: 7. æäº¤ç´ æå…ƒæ•°æ®(POST /materials)
```

**å…³é”®ä»£ç æ®µ**ï¼š
```typescript
// cavasUtil.ts ä¸­çš„æ ¸å¿ƒä¸Šä¼ é€»è¾‘
const uploadImageForCavas = (ops: CavasUpdateOps) => {
  // èŽ·å–æ–‡ä»¶æ‰©å±•å
  const fileExtension = ops.fileExtension.toLowerCase();
  
  // æ ¹æ®ä¸åŒæ–‡ä»¶ç±»åž‹å¤„ç†
  if (fileExtension === 'svg') {
    handleSvgUpload(ops);
  } else if (fileExtension === 'psd') {
    handlePsdUpload(ops);
  } else {
    // ç›´æŽ¥ä¸Šä¼ å…¶ä»–æ ¼å¼
    directUpload(ops);
  }
}

// å®žé™…è°ƒç”¨OSS SDKçš„ä¸Šä¼ æ–¹æ³•
const upload2dEditFile = async (file: File, fileType: GetUpTokenFileTypeEnum) => {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('policy', ossPolicy); // åŒ…å«ç­¾åçš„ä¸Šä¼ ç­–ç•¥
  formData.append('OSSAccessKeyId', accessKeyId);
  
  try {
    const response = await fetch(OSS_ENDPOINT, {
      method: 'PUT',
      body: formData
    });
    return await response.json();
  } catch (error) {
    ConsoleUtil.error('OSS Upload Failed:', error);
    throw error;
  }
}
```

### 4. è·¨åŸŸè§£å†³æ–¹æ¡ˆ
**ðŸŒ‰ è·¨åŸŸå¤„ç†é‡‡ç”¨å¤šå±‚é˜²å¾¡ç­–ç•¥**ï¼š

1. **OSSæœåŠ¡ç«¯é…ç½®**ï¼š
```json
// OSS Bucketçš„CORSé…ç½®ç¤ºä¾‹
[
  {
    "AllowedOrigin": ["https://yourdomain.com"],
    "AllowedMethod": ["GET", "PUT", "POST"],
    "AllowedHeader": ["*"],
    "ExposeHeader": ["ETag", "x-oss-request-id"],
    "MaxAgeSeconds": 3000
  }
]
```

2. **å‰ç«¯ä»£ç†æ–¹æ¡ˆ**ï¼š
```nginx
# Nginxåå‘ä»£ç†é…ç½®
location /oss-proxy/ {
    rewrite ^/oss-proxy/(.*) /$1 break;
    proxy_pass https://your-bucket.oss-cn-hangzhou.aliyuncs.com;
    
    # æ·»åŠ CORSå¤´
    add_header 'Access-Control-Allow-Origin' '$http_origin' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
    add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
}
```

3. **å®¢æˆ·ç«¯å¤„ç†æ–¹æ¡ˆ**ï¼š
```typescript
// åœ¨fetchè¯·æ±‚ä¸­å¤„ç†è·¨åŸŸ
const uploadFile = async (file: File) => {
  try {
    const response = await fetch(OSS_ENDPOINT, {
      method: 'PUT',
      mode: 'cors', // æ˜¾å¼å£°æ˜ŽCORSæ¨¡å¼
      headers: new Headers({
        'Content-Type': 'application/octet-stream',
        'x-oss-security-token': securityToken
      }),
      body: file
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const result = await response.json();
    ConsoleUtil.log('Upload Success:', result);
  } catch (error) {
    ConsoleUtil.error('Upload Failed:', error);
    // é‡è¯•é€»è¾‘
    if (isNetworkError(error)) {
      retryUpload(file);
    }
  }
}
```

### 5. è¡¥å……è¯´æ˜Ž
**ðŸ” å®‰å…¨å¢žå¼ºæŽªæ–½**ï¼š

1. **ä¸´æ—¶å‡­è¯æœºåˆ¶**ï¼š
   - å‰ç«¯æ¯æ¬¡ä¸Šä¼ å‰ä»Žä¸šåŠ¡æœåŠ¡å™¨èŽ·å–ä¸´æ—¶STS Token
   - Tokenæœ‰æ•ˆæœŸé™åˆ¶ä¸º5åˆ†é’Ÿ
   - æƒé™èŒƒå›´ç²¾ç¡®åˆ°æŒ‡å®šç›®å½•

2. **æ–‡ä»¶æ ¡éªŒç­–ç•¥**ï¼š
```typescript
// æ–‡ä»¶ç±»åž‹ç™½åå•æ ¡éªŒ
const ALLOWED_TYPES = [
  'image/jpeg', 'image/png', 
  'image/svg+xml', 'application/pdf',
  'application/psd', 'application/illustrator'
];

function validateFile(file: File) {
  if (!ALLOWED_TYPES.includes(file.type)) {
    throw new Error('Unsupported file type');
  }
  
  // æ–‡ä»¶å¤§å°é™åˆ¶50MB
  if (file.size > 50 * 1024 * 1024) {
    throw new Error('File size exceeds 50MB limit');
  }
}
```

3. **ä¸Šä¼ ç›‘æŽ§æŒ‡æ ‡**ï¼š
```typescript
// ä¸Šä¼ æ€§èƒ½ç›‘æŽ§
const startTime = performance.now();

uploadFile(file).then(() => {
  const duration = performance.now() - startTime;
  // ä¸ŠæŠ¥æŒ‡æ ‡
  reportMetrics({
    event: 'upload_success',
    file_size: file.size,
    file_type: file.type,
    duration: duration
  });
});
```
