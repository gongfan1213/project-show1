> ğŸ’­ å¥½çš„ï¼Œæˆ‘ç°åœ¨éœ€è¦åˆ†æç”¨æˆ·æä¾›çš„è¿™æ®µç»Ÿè®¡ä¸ŠæŠ¥ç®¡ç†å™¨çš„ä»£ç ï¼Œæ‰¾å‡ºæ½œåœ¨çš„é—®é¢˜å’Œæ”¹è¿›ç‚¹ã€‚é¦–å…ˆï¼Œæˆ‘éœ€è¦ä»”ç»†é˜…è¯»ä»£ç ï¼Œç†è§£å…¶ç»“æ„å’ŒåŠŸèƒ½ã€‚
>
> é¦–å…ˆï¼Œä»£ç ç®¡ç†ç»Ÿè®¡æ•°æ®çš„ä¸ŠæŠ¥ï¼Œä½¿ç”¨IndexedDBå­˜å‚¨æ•°æ®ï¼Œç¡®ä¿åœ¨é¡µé¢å…³é—­æˆ–ç½‘ç»œé—®é¢˜çš„æƒ…å†µä¸‹æ•°æ®ä¸ä¼šä¸¢å¤±ã€‚å¯åŠ¨æ—¶å¤„ç†é—ç•™æ•°æ®ï¼Œå®šæœŸæˆ–è¾¾åˆ°æ•°é‡ä¸Šé™æ—¶ä¸ŠæŠ¥ï¼Œé€€å‡ºæ—¶æ ‡è®°æ•°æ®ä¸ºå…³é—­ã€‚
>
> è§‚å¯Ÿåˆ°çš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯initæ–¹æ³•ä¸­çš„æ—¶é—´è®¡ç®—ã€‚ä»£ç é‡ŒæŠŠtwentyFourHoursè®¾ä¸º3*60*1000ï¼Œå³3åˆ†é’Ÿï¼Œä½†å˜é‡åå´æ˜¯äºŒåå››å°æ—¶ã€‚è¿™æ˜¾ç„¶æ˜¯ä¸ªé”™è¯¯ï¼Œä¼šå¯¼è‡´åŸæœ¬åº”24å°æ—¶å¤„ç†çš„æ•°æ®åœ¨3åˆ†é’Ÿå°±è¢«å¤„ç†ï¼Œå¯èƒ½è¿‡æ—©åˆ é™¤æœªä¸ŠæŠ¥çš„æ•°æ®ã€‚
>
> æ¥ä¸‹æ¥ï¼Œä¸ŠæŠ¥é€»è¾‘ä¸­çš„reportDataæ–¹æ³•ã€‚å½“ä¸ŠæŠ¥æˆåŠŸåï¼Œä»£ç ä½¿ç”¨filterè¿‡æ»¤æ‰å·²ä¸ŠæŠ¥çš„äº‹ä»¶ã€‚ä½†eventsToReportæ˜¯é€šè¿‡sliceå–å‰20æ¡ï¼Œfilterä½¿ç”¨includesæ£€æŸ¥ï¼Œä½†ç”±äºå¯¹è±¡å¼•ç”¨ä¸åŒï¼Œå¯èƒ½æ— æ³•æ­£ç¡®è¿‡æ»¤ï¼Œå¯¼è‡´æ•°æ®é‡å¤ä¸ŠæŠ¥æˆ–æœªè¢«ç§»é™¤ã€‚åº”è¯¥æ”¹ç”¨spliceæ¥ç›´æ¥åˆ é™¤å‰Næ¡ï¼Œæˆ–è€…è®°å½•äº‹ä»¶çš„å”¯ä¸€æ ‡è¯†è¿›è¡Œæ¯”è¾ƒã€‚
>
> IndexedDBæ“ä½œç¼ºä¹é”™è¯¯å¤„ç†ã€‚æ¯”å¦‚ï¼Œåœ¨initä¸­å¤„ç†é—ç•™æ•°æ®æ—¶ï¼Œè°ƒç”¨storage.deleteä½†æ²¡æœ‰æ•è·å¯èƒ½çš„é”™è¯¯ï¼Œå¦‚æœåˆ é™¤å¤±è´¥ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®é‡å¤å¤„ç†ã€‚éœ€è¦æ·»åŠ try-catchå—æ¥å¤„ç†å¼‚å¸¸ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚
>
> æ­¤å¤–ï¼ŒunInitæ–¹æ³•ä¸­åœ¨é¡µé¢å…³é—­æ—¶æ ‡è®°isCloseä¸ºtrueå¹¶ä¿å­˜ï¼Œä½†å¼‚æ­¥æ“ä½œå¯èƒ½æœªå®Œæˆé¡µé¢å°±å·²å…³é—­ï¼Œå¯¼è‡´æ ‡è®°å¤±è´¥ã€‚åº”è¯¥è€ƒè™‘ä½¿ç”¨navigator.sendBeaconåœ¨beforeunloadäº‹ä»¶ä¸­åŒæ­¥å‘é€æ•°æ®ï¼Œç¡®ä¿æ•°æ®å¯é ä¿å­˜ã€‚
>
> ä»£ç ä¸­è¿˜æœ‰ä¸€äº›é­”æ³•æ•°å­—ï¼Œå¦‚ä¸ŠæŠ¥é—´éš”å’Œæœ€å¤§äº‹ä»¶æ•°ï¼Œç›´æ¥å†™åœ¨ä»£ç é‡Œï¼Œä¸ä¾¿äºç»´æŠ¤ã€‚å»ºè®®æå–ä¸ºé…ç½®å¸¸é‡ï¼Œæé«˜å¯è¯»æ€§å’Œçµæ´»æ€§ã€‚
>
> åœ¨addStatisticalEventæ–¹æ³•ä¸­ï¼Œå‚æ•°å¤„ç†éƒ¨åˆ†ã€‚å½“valueæ˜¯å¯¹è±¡æ—¶ï¼Œä¼šå±•å¼€å¹¶æ·»åŠ extraå’Œtsï¼Œä½†å¯èƒ½è¦†ç›–åŸæœ‰å±æ€§ã€‚ä¾‹å¦‚ï¼Œå¦‚æœvalueæœ¬èº«æœ‰extraå±æ€§ï¼Œä¼šè¢«è¦†ç›–ã€‚éœ€è¦åˆå¹¶extraå­—æ®µï¼Œæˆ–è€…ç¡®ä¿ä¸å†²çªã€‚
>
> è¿˜æœ‰ï¼Œä¸ŠæŠ¥æ¥å£çš„å¼‚å¸¸å¤„ç†ï¼ŒsendReportæ–¹æ³•æ•è·äº†å¼‚å¸¸å¹¶è¿”å›nullï¼Œä½†æœªè®°å½•é”™è¯¯æ—¥å¿—ï¼Œä¸åˆ©äºæ’æŸ¥é—®é¢˜ã€‚åº”è¯¥æ·»åŠ æ—¥å¿—è®°å½•ï¼Œæ–¹ä¾¿åç»­ç›‘æ§å’Œè°ƒè¯•ã€‚
>
> æœ€åï¼Œåˆå§‹åŒ–æ—¶çš„setIntervalå¯èƒ½åœ¨é¡µé¢éšè—æ—¶ç»§ç»­è¿è¡Œï¼Œæµªè´¹èµ„æºã€‚å¯ä»¥è€ƒè™‘ä½¿ç”¨Page Visibility APIï¼Œåœ¨é¡µé¢ä¸å¯è§æ—¶æš‚åœä¸ŠæŠ¥ï¼Œå¯è§æ—¶æ¢å¤ï¼Œä¼˜åŒ–æ€§èƒ½ã€‚
>
> æ€»ç»“ä»¥ä¸Šé—®é¢˜ï¼Œéœ€è¦é€æ­¥è¿›è¡ŒéªŒè¯å’Œä¿®æ­£ï¼Œç¡®ä¿ä»£ç çš„å¥å£®æ€§å’Œå¯é æ€§ã€‚
>
> 



ä»¥ä¸‹æ˜¯é’ˆå¯¹æä¾›çš„ä»£ç çš„è¯¦ç»†åˆ†æåŠæ”¹è¿›å»ºè®®ï¼š

---

### ä¸€ã€ä»£ç é€»è¾‘åˆ†æ

è¯¥ä»£ç æ˜¯ä¸€ä¸ªç»Ÿè®¡ä¸ŠæŠ¥ç®¡ç†å™¨ï¼Œä¸»è¦åŠŸèƒ½å¦‚ä¸‹ï¼š
1. **æ•°æ®å­˜å‚¨**ï¼šä½¿ç”¨ IndexedDB å­˜å‚¨ç»Ÿè®¡äº‹ä»¶ï¼Œæ”¯æŒç¦»çº¿ç¼“å­˜ã€‚
2. **é—ç•™æ•°æ®å¤„ç†**ï¼šåœ¨é¡µé¢åŠ è½½æ—¶æ¸…ç†è¿‡æœŸçš„å†å²æ•°æ®ï¼ˆæ ‡è®°ä¸ºå·²å…³é—­æˆ–è¶…è¿‡ä¸€å®šæ—¶é—´æœªæ›´æ–°ï¼‰ã€‚
3. **å‘¨æœŸæ€§ä¸ŠæŠ¥**ï¼šå®šæ—¶ï¼ˆé»˜è®¤5åˆ†é’Ÿï¼‰æˆ–æŒ‰æ•°é‡ï¼ˆæ»¡20æ¡äº‹ä»¶ï¼‰è§¦å‘ä¸ŠæŠ¥ã€‚
4. **å…³é—­æ ‡è®°ä¸æ¸…ç†**ï¼šé¡µé¢å¸è½½æ—¶æ ‡è®°æ•°æ®ä¸ºå·²å…³é—­ï¼Œé˜²æ­¢æœªä¸ŠæŠ¥æ•°æ®ä¸¢å¤±ã€‚
5. **äº‹ä»¶æ ¼å¼å¤„ç†**ï¼šæ”¯æŒåŠ¨æ€å‚æ•°åˆå¹¶ï¼Œé€‚é…ä¸åŒäº‹ä»¶ç±»å‹ã€‚

---

### äºŒã€å…³é”®é—®é¢˜åˆ†æä¸æ”¹è¿›å»ºè®®

#### 1. **æ—¶é—´å˜é‡å‘½åé”™è¯¯ä¸é˜ˆå€¼é—®é¢˜**
   - **é—®é¢˜**ï¼š
     ```typescript
     // åŸå§‹ä»£ç 
     const twentyFourHours = 3 * 60 * 1000; // è¯¯å†™ä¸º3åˆ†é’Ÿ
     ```
     å˜é‡å `twentyFourHours` é”™è¯¯èµ‹å€¼ä¸º `3åˆ†é’Ÿ`ï¼Œå¯¼è‡´æ¸…ç†é€»è¾‘å¯èƒ½è¿‡æ—©åˆ é™¤æœªä¸ŠæŠ¥æ•°æ®ã€‚
   - **æ”¹è¿›**ï¼š
     ```typescript
     const CLEANUP_THRESHOLD_MS = 24 * 60 * 60 * 1000; // ä¿®æ­£ä¸º24å°æ—¶
     if (data.isClose || (now - data.updateTime) > CLEANUP_THRESHOLD_MS)
     ```

#### 2. **ä¸ŠæŠ¥åæ•°æ®è¿‡æ»¤é€»è¾‘é”™è¯¯**
   - **é—®é¢˜**ï¼š
     ```typescript
     // åŸå§‹ä»£ç ï¼šä½¿ç”¨ includes æ£€æŸ¥å¯¹è±¡æ˜¯å¦å­˜åœ¨äºæ•°ç»„ä¸­
     this.pageDataTemp.data = this.pageDataTemp.data.filter(event => 
       !eventsToReport.includes(event)
     );
     ```
     ç”±äº `eventsToReport` é€šè¿‡ `slice()` åˆ‡å‰²ï¼Œè¿”å›çš„æ˜¯åŸæ•°ç»„å¯¹è±¡çš„å¼•ç”¨ï¼ŒHTTP ä¸ŠæŠ¥å¯èƒ½å¼‚æ­¥å®Œæˆæ—¶ï¼Œ`filter` ä¸­çš„ `includes` ä¼šå› ä¸ºäº‹ä»¶å·²ä¿®æ”¹è€Œå¤±æ•ˆï¼Œå¯¼è‡´è¿‡æ»¤ä¸å‡†ç¡®ã€‚
   - **æ”¹è¿›**ï¼š
     ```typescript
     // ç›´æ¥æˆªæ–­å·²ä¸ŠæŠ¥çš„æ¡ç›®
     this.pageDataTemp.data.splice(0, eventsToReport.length);
     ```

#### 3. **IndexedDB æ“ä½œç¼ºä¹é”™è¯¯å¤„ç†**
   - **é—®é¢˜**ï¼š
     ```typescript
     // åŸå§‹ä»£ç ï¼šæ²¡æœ‰æ•è· delete æˆ– put æ“ä½œçš„å¼‚å¸¸
     this.storage.delete(String(key));
     ```
     å½“ IndexedDB æ“ä½œå¤±è´¥æ—¶ï¼ˆå¦‚ç”¨æˆ·ç¦ç”¨å­˜å‚¨ï¼‰ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚
   - **æ”¹è¿›**ï¼š
     ```typescript
     try {
       await this.storage.delete(String(key));
     } catch (error) {
       ConsoleUtil.error('[Statistical] Failed to delete data:', error);
     }
     ```

#### 4. **é¡µé¢å…³é—­æ—¶ä¸ŠæŠ¥ä¸å¯é **
   - **é—®é¢˜**ï¼š
     `unInit` é€šè¿‡æ ‡è®° `isClose` ä¿å­˜åˆ° IndexedDBï¼Œä½†é¡µé¢å…³é—­æ—¶å¼‚æ­¥æ“ä½œå¯èƒ½è¢«ä¸­æ–­ã€‚
   - **æ”¹è¿›**ï¼š
     ä½¿ç”¨ `beforeunload` ç»“åˆ `navigator.sendBeacon` åŒæ­¥ä¸ŠæŠ¥å…³é”®æ•°æ®ï¼š
     ```typescript
     window.addEventListener('beforeunload', () => {
       const data = JSON.stringify(this.pageDataTemp?.data || []);
       navigator.sendBeacon('/app/logging/upload_events', data);
     });
     ```

#### 5. **é­”æ³•æ•°å­—ä¸ç¡¬ç¼–ç é…ç½®**
   - **é—®é¢˜**ï¼š
     ä¸ŠæŠ¥å‘¨æœŸï¼ˆ5åˆ†é’Ÿï¼‰ã€æœ€å¤§äº‹ä»¶æ•°ï¼ˆ20ï¼‰ç­‰ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼Œç»´æŠ¤ä¸ä¾¿ã€‚
   - **æ”¹è¿›**ï¼š
     æå–ä¸ºé…ç½®å¸¸é‡ï¼š
     ```typescript
     const REPORT_CONFIG = {
       INTERVAL_MS: 5 * 60 * 1000, // 5åˆ†é’Ÿ
       MAX_EVENTS: 20,
       CLEANUP_THRESHOLD_MS: 24 * 60 * 60 * 1000,
     };
     ```

#### 6. **äº‹ä»¶å‚æ•°åˆå¹¶é£é™©**
   - **é—®é¢˜**ï¼šè‹¥ `value` å·²åŒ…å« `extra` æˆ– `ts` å­—æ®µï¼Œå¯èƒ½è¢«è¦†ç›–ã€‚
     ```typescript
     params = { ...value, extra: extra, ts: Date.now() };
     ```
   - **æ”¹è¿›**ï¼šæ˜ç¡®åˆå¹¶ç­–ç•¥ï¼š
     ```typescript
     const params = { 
       ...(typeof value === 'object' ? value : { value }), // åˆå¹¶value
       ...(extra && { extra }), // ä¸Šå±‚extraä¼˜å…ˆçº§æ›´é«˜
       ts: Date.now(),
     };
     ```

#### 7. **ç½‘ç»œå¤±è´¥é‡è¯•æœºåˆ¶ç¼ºå¤±**
   - **é—®é¢˜**ï¼šå¤±è´¥äº‹ä»¶ä¼šè¢«ä¿ç•™ä½†æ— é‡è¯•é€»è¾‘ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®å †ç§¯ã€‚
   - **æ”¹è¿›**ï¼šæ·»åŠ é‡è¯•è®¡æ•°å™¨ä¸é€€é¿ç­–ç•¥ï¼š
     ```typescript
     interface StatisticTableModel {
       // æ–°å¢é‡è¯•å­—æ®µ
       retries?: number;
     }

     // ä¸ŠæŠ¥å¤±è´¥æ—¶å¢åŠ é‡è¯•æ¬¡æ•°
     if (!isNetSuccess(sendRet)) {
       this.pageDataTemp.retries = (this.pageDataTemp.retries || 0) + 1;
       if (this.pageDataTemp.retries < MAX_RETRIES) {
         // é€€é¿ç­–ç•¥ï¼Œå¦‚ 2^retries * baseDelay
         setTimeout(() => this.reportData(), 1000 * Math.pow(2, this.pageDataTemp.retries));
       }
     }
     ```

---

### ä¸‰ã€å…¶ä»–ä¼˜åŒ–å»ºè®®

1. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨ Page Visibility API åœ¨é¡µé¢ä¸å¯è§æ—¶æš‚åœä¸ŠæŠ¥ï¼š
     ```typescript
     document.addEventListener('visibilitychange', () => {
       if (document.hidden) {
         clearInterval(this.intervalId!);
       } else {
         this.intervalId = setInterval(...);
       }
     });
     ```

2. **æ—¥å¿—ä¸ç›‘æ§**ï¼š
   - è®°å½•å…³é”®æ“ä½œæ—¥å¿—ï¼Œè¾…åŠ©æ’æŸ¥é—®é¢˜ï¼š
     ```typescript
     ConsoleUtil.log('[Statistical] æˆåŠŸä¸ŠæŠ¥äº‹ä»¶æ•°:', eventsToReport.length);
     ```

3. **ç±»å‹å®‰å…¨å¢å¼º**ï¼š
   - ä½¿ç”¨æ›´ä¸¥æ ¼çš„ TypeScript ç±»å‹çº¦æŸï¼Œé¿å…å‚æ•°é”™è¯¯ï¼š
     ```typescript
     interface EventParams {
       [key: string]: any;
       ts: number;
       extra?: any;
     }
     ```

---

### å››ã€æ€»ç»“

è¯¥ä»£ç åœ¨ç¦»çº¿å­˜å‚¨ã€å‘¨æœŸä¸ŠæŠ¥ç­‰åœºæ™¯ä¸‹å…·å¤‡ä¸€å®šå¥å£®æ€§ï¼Œä½†ä»éœ€è§£å†³ **æ—¶é—´é˜ˆå€¼é”™è¯¯ã€æ•°æ®è¿‡æ»¤é€»è¾‘ã€å¼‚æ­¥æ“ä½œå¯é æ€§ã€é”™è¯¯å¤„ç†** ç­‰å…³é”®é—®é¢˜ã€‚é€šè¿‡ä¿®å¤é€»è¾‘æ¼æ´ã€å¢å¼ºå¼‚å¸¸å¤„ç†ã€ä¼˜åŒ–æ€§èƒ½ï¼Œå¯æ˜¾è‘—æå‡ç»Ÿè®¡ç³»ç»Ÿçš„å¯é æ€§ã€‚å»ºè®®å¯¹ç…§æ”¹è¿›ç‚¹é€æ­¥ä¼˜åŒ–ï¼ŒåŒæ—¶æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•ï¼ˆå¦‚æ¨¡æ‹Ÿç½‘ç»œå¤±è´¥ã€é¡µé¢å…³é—­åœºæ™¯ï¼‰ç¡®ä¿æ”¹åŠ¨ç¨³å®šæ€§ã€‚
