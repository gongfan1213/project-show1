### 浮雕画生成技术  

浮雕画生成技术是指输入一张彩色图，生成与原图纹理相似、具有浮雕效果的3D模型。通过分层处理和颜色提取，进行模型上色。主要工具包括 OpenCV 和 Open3D。  

---

### 1. 彩色图转 Triangle Mesh  

#### 技术路线  
1. **输入图片**  
2. **图像前处理**  
3. **灰度图转高度图**  
4. **构建 Triangle Mesh 坐标系**  
5. **生成 Triangle Mesh 3D 模型**  
6. **3D模型后处理**  
7. **保存为 STL 格式**  

---

#### 1.1 灰度化  
将彩色输入图 (RGB) 转化为灰度图 (Gray)，计算公式如下：  
```  
gray = 0.2989 * r + 0.5870 * g + 0.1140 * b  
```  
- `r, g, b` 分别为彩色图的红、绿、蓝通道值。  
- OpenCV 需注意 RGB 通道信息顺序为 BGR。  

---

#### 1.2 灰度值转高度值  
通过以下公式将灰度值转为高度值：  
```  
height = (meshMax - meshMin) * (grayValue - grayMin) / (grayMax - grayMin) + meshMin  
```  
- `meshMax` 和 `meshMin` 为生成的 Mesh 最大最小高度。  
- `grayValue` 为每个像素的灰度值。  

---

#### 1.3 构建 Triangle Mesh  
通过点云生成 Triangle Mesh 3D 模型，使用 Open3D 的 `open3d.geometry.TriangleMesh`。  
- **主要属性**：  
  1. **顶点坐标 (Vertices)**：存储三角网格的顶点坐标。  
  2. **三角形索引 (Triangles)**：存储三角网格的三角形索引。  
  3. **法线 (Normals)**：存储三角网格的法线，用于光照和渲染效果。  

---

#### 1.4 Mesh 减面技巧  
- **Scale 操作**：通过缩小尺寸后再放大到实际需要的尺寸，减少计算复杂度。  
- **优化效果**：  
  - 缩短生成时间，提升效率。  
  - STL 模型大小减少约 7 倍，节省存储和计算资源。  

---

### 2. 彩色图提取颜色信息  

#### 技术路线  
1. **输入图片**  
2. **确定聚类个数**  
3. **颜色聚类**  
4. **提取颜色转高度**  
5. **调整分层点**  
6. **输出最终分层和对应颜色**  

---

#### 2.1 彩色图估计颜色数目  
利用肘部法则 (Elbow Method) 确定聚类数目（即分层数）。  
- **步骤**：  
  1. 计算误差值：对每个聚类数，计算 WCSS (Within-Cluster-Sum-of-Squares)。  
  2. 多次运行聚类算法：使用不同聚类数，计算误差值。  
  3. 绘制误差值曲线：观察误差值随聚类数的变化。  
  4. 查找“肘部”：误差值减少速率显著降低的点即为最佳聚类数。  

- **核心思想**：探索数据中聚类的数量与每个点到其聚类中心的平均距离之间的关系。  

--- 

### 总结  
通过彩色图转 Triangle Mesh 和颜色提取技术，可以高效生成具有浮雕效果的3D模型，并通过优化技术减少计算资源和存储空间。
### 2.2 彩色图聚类  
通过确定聚类数目后，使用 K-means 算法进行聚类，提取聚类后每个簇的中心点，即为每个分层的颜色值。  

#### K-means 参数说明  
1. **pixels**  
   - 输入数据的样本集，是一个浮点数矩阵，每行是一个 RGB 像素打平后的向量 `(row*col, 3)`。  

2. **layer_num**  
   - 聚类的数量，即分组的数量，对应 K-means 中的“K”。  

3. **labels**  
   - 输出参数，存储每个样本的标签（即每个样本所属的聚群索引）。  

4. **cv::TermCriteria**  
   - 终止迭代的条件，可设置为以下三种之一或组合：  
     - **EPS**：当聚群中心在两次迭代中的移动距离小于 EPS 值时，算法停止。  
     - **MAX_ITER**：达到最大迭代次数时停止。  
     - **COUNT**：达到指定的最大迭代次数时停止。  
   - 示例中设置：最大迭代次数为 100，epsilon 为 0.1。  

5. **attempts = 5**  
   - K-means 算法尝试次数，选择最佳结果。  

6. **cv::KMEANS_PP_CENTERS**  
   - 用于初始化中心的方法，常用 K-means++，通过概率机制智能选择初始簇中心。  

---

### 2.3 模型分层  
1. **按聚类中心排序**  
   - 按照聚类数量从小到大排序，将排序后的 `color_range` 转为灰度值 `gray_range`。  

2. **高度范围预估**  
   - 根据聚类类数目，对每层高度范围进行大致预估。  

3. **高度值排序**  
   - 将灰度值转为高度值 `height_range`，并对范围进行排序，输出 `sorted_indices` 排序下标序列，便于 `colors_range` 和 `height_range` 重新排序。  

4. **分层调整**  
   - 判断高度值是否在粗略计算的范围内，若不在范围内则进行上下限判断和替换。  
   - 进行固定层高（如 0.2）的切层处理，输出每层层号序列。  
   - 示例：  
     ```
     Height Ranges: [0, 0.75] [0.75, 1.52858] [1.52858, 2.25] [2.25, 3]  
     Layer Ranges: { [1, 4] [5, 8] [9, 12] [13, 15] }  
     ```  

---

### 2.4 模型上色  
- 遍历模型每个顶点，判断顶点处于哪个分层，赋予顶点相应的分层颜色。  

---

### 4. 总结  
- **模型减面效果**  
  - 减面能降低约 9 倍的 Mesh 生成速度，内存大小降低 10 倍，减面后的模型普遍在 20-40MB 之间，具体取决于模型面积。  

- **TODO**  
  1. 优化提取颜色的准确性。  
  2. 优化确定聚类数目的方法。  
  3. 优化分层信息的处理速度。  
  4. 加入语义信息，去理解图像的“点睛之笔”，生成更真实的 Mesh 模型。  
